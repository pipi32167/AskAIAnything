<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI优化功能测试</title>
    <link rel="stylesheet" href="settings.css">
</head>
<body>
    <div class="settings-container">
        <div class="settings-header">
            <h1>AI优化功能测试</h1>
            <p class="subtitle">测试新添加的AI优化提示词功能</p>
        </div>

        <div class="prompts-section" style="padding: 30px;">
            <h2>测试提示词编辑</h2>

            <!-- 模拟提示词编辑界面 -->
            <div class="prompt-item" style="border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div class="form-row">
                    <label class="form-label">用户提示词模板:</label>
                    <textarea class="prompt-edit-template" placeholder="请输入提示词模板..." rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">请分析以下文字：&#10;&#10;{text}</textarea>
                </div>

                <div class="form-row">
                    <button class="ai-optimize-btn" title="使用AI优化此提示词">
                        🤖 AI优化提示词
                    </button>
                </div>

                <div class="prompt-edit-actions" style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="cancel-btn btn btn-secondary">取消</button>
                    <button class="save-btn btn btn-primary">保存</button>
                </div>
            </div>

            <div id="statusMessage" class="status-message" style="display: none; margin-top: 20px;"></div>
        </div>
    </div>

    <script src="i18n.js"></script>
    <script>
        // 模拟chrome.storage API
        const chrome = {
            storage: {
                sync: {
                    get: (keys) => {
                        return new Promise((resolve) => {
                            // 模拟配置数据
                            resolve({
                                apiKey: 'test-api-key',
                                apiEndpoint: 'https://api.openai.com/v1/chat/completions',
                                apiModel: 'gpt-3.5-turbo',
                                maxTokens: 500
                            });
                        });
                    }
                }
            }
        };

        // 模拟showStatus函数
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';

            if (type === 'success') {
                statusEl.style.background = '#d4edda';
                statusEl.style.color = '#155724';
                statusEl.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusEl.style.background = '#f8d7da';
                statusEl.style.color = '#721c24';
                statusEl.style.border = '1px solid #f5c6cb';
            }

            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // AI优化提示词功能（从settings.js复制）
        async function aiOptimizePrompt(templateTextarea, buttonElement) {
            const originalText = buttonElement.textContent;
            const currentPrompt = templateTextarea.value.trim();

            if (!currentPrompt) {
                showStatus("请先输入提示词内容", "error");
                return;
            }

            // 显示加载状态
            buttonElement.textContent = "🔄 优化中...";
            buttonElement.disabled = true;

            try {
                // 获取API配置
                const config = await chrome.storage.sync.get([
                    "apiKey",
                    "apiEndpoint",
                    "apiModel",
                    "maxTokens",
                ]);

                if (!config.apiKey) {
                    throw new Error("请先配置API密钥");
                }

                // 模拟AI优化过程（实际应用中会调用真实API）
                console.log("正在调用AI API优化提示词...");
                console.log("当前提示词:", currentPrompt);

                // 模拟API调用延迟
                await new Promise(resolve => setTimeout(resolve, 2000));

                // 模拟优化结果
                const optimizedPrompt = `请深入分析以下文本内容，从多个角度进行解读和评估：

文本内容：{text}

请提供：
1. 核心观点总结
2. 关键信息提取
3. 深层次含义分析
4. 实际应用建议`;

                if (optimizedPrompt) {
                    // 更新文本框内容
                    templateTextarea.value = optimizedPrompt;
                    showStatus("提示词优化成功！", "success");
                } else {
                    throw new Error("AI返回的优化结果为空");
                }

            } catch (error) {
                console.error("AI优化提示词失败:", error);
                showStatus(`优化失败: ${error.message}`, "error");
            } finally {
                // 恢复按钮状态
                buttonElement.textContent = originalText;
                buttonElement.disabled = false;
            }
        }

        // 添加事件监听器
        document.addEventListener('DOMContentLoaded', () => {
            const aiOptimizeBtn = document.querySelector('.ai-optimize-btn');
            const templateTextarea = document.querySelector('.prompt-edit-template');

            aiOptimizeBtn.addEventListener('click', () => {
                aiOptimizePrompt(templateTextarea, aiOptimizeBtn);
            });
        });
    </script>
</body>
</html>